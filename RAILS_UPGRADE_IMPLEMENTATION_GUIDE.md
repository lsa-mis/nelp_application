# Rails 7.2.2.1 Implementation Guide
## Technical Checklist and Commands

This document provides the step-by-step technical implementation guide for upgrading the `lsa-mis/nelp_application` from Rails 6.1.7.7 to Rails 7.2.2.1.

## Pre-Implementation Setup

### 1. Create Backup and Branch Strategy

```bash
# Create a backup branch from current master
git checkout master
git pull origin master
git checkout -b rails-upgrade-backup

# Create feature branch for upgrade work
git checkout master
git checkout -b feature/rails-7-2-upgrade

# Push backup branch
git push origin rails-upgrade-backup
```

### 2. Audit Current Dependencies

```bash
# Check current Rails version
bundle exec rails --version

# Check current Ruby version  
ruby --version

# Generate dependency report
bundle outdated > dependency_audit.txt

# Check gem compatibility (install railsbump gem if needed)
gem install railsbump
railsbump check
```

## Phase 1: Rails 7.0 Upgrade

### 1.1 Update Gemfile

```ruby
# In Gemfile, update Rails version
gem 'rails', '~> 7.0.8'

# Add sprockets-rails (now required explicitly)
gem 'sprockets-rails'

# Update Spring if present
gem 'spring', '~> 4.0' # in development group

# Update other critical gems
gem 'bootsnap', '>= 1.4.4', require: false
gem 'webpacker', '~> 5.4' # or consider upgrading
```

### 1.2 Bundle Update Commands

```bash
# Conservative update approach
bundle update rails
bundle update sprockets-rails
bundle update spring

# If there are dependency conflicts, try:
bundle update --conservative rails sprockets-rails spring

# Full bundle update (use with caution)
# bundle update
```

### 1.3 Run Rails Update Command

```bash
# Generate new configuration files
bin/rails app:update

# When prompted, choose:
# - Overwrite config files: Review each one carefully
# - Keep application-specific configurations
# - Note the generated new_framework_defaults_7_0.rb file
```

### 1.4 Update Application Configuration

**In `config/application.rb`:**
```ruby
module NelpApplication
  class Application < Rails::Application
    # Keep current defaults during transition
    config.load_defaults 6.1
    
    # Add Rails 7.0 specific configurations
    # (These will be moved to load_defaults 7.0 later)
    
    # Don't generate system test files.
    config.generators.system_tests = nil
  end
end
```

**Review and update `config/environments/` files based on generated changes**

### 1.5 Critical Rails 7.0 Configuration Changes

**Add to `config/initializers/` (if not already present):**

```ruby
# config/initializers/new_framework_defaults_7_0.rb
# (Generated by rails app:update, review and uncomment gradually)

# Enable the new cookie format
Rails.application.config.action_dispatch.cookies_serializer = :json

# Enable cache format version 7.0
# Rails.application.config.active_support.cache_format_version = 7.0

# Other new defaults...
```

### 1.6 Fix Zeitwerk Issues

**Check for autoloading problems:**
```bash
# Boot the application and check for autoloading errors
bin/rails console

# Run zeitwerk check
bin/rails zeitwerk:check
```

**Common fixes needed:**
- Remove manual `require` statements for app files
- Fix file naming conventions (e.g., `FooBar` class should be in `foo_bar.rb`)
- Move concerns properly if using non-standard paths

### 1.7 Asset Pipeline Updates

**If keeping Webpacker:**
```bash
# Check Webpacker compatibility
bin/rails webpacker:info

# Update if needed
bundle update webpacker
```

**If migrating to Sprockets only:**
```ruby
# In config/application.rb
require 'sprockets/railtie'

# Remove webpacker references from application.html.erb
# <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
# becomes:
# <%= javascript_importmap_tags %>
```

### 1.8 Update Initializers

**Review and update these initializers for Rails 7.0:**
- `config/initializers/filter_parameter_logging.rb`
- `config/initializers/permissions_policy.rb` (new)
- `config/initializers/assets.rb`

### 1.9 Fix Deprecation Warnings

**Common Rails 7.0 deprecations to fix:**

1. **ActiveModel::Errors changes:**
```ruby
# Old way (deprecated)
user.errors[:email] << "is invalid"
user.errors.keys

# New way
user.errors.add(:email, "is invalid")  
user.errors.attribute_names
```

2. **Form helpers:**
```ruby
# Old way (may need adjustment)
button_to "Edit", user_path(@user)

# New way (if @user is persisted, specify method)
button_to "Edit", user_path(@user), method: :get
```

### 1.10 Database and Migration Updates

```bash
# Check for any migration issues
bin/rails db:migrate:status

# Run any pending migrations
bin/rails db:migrate

# Test database operations
bin/rails db:test:prepare
```

## Phase 2: Rails 7.1 Upgrade

### 2.1 Update to Rails 7.1

```ruby
# In Gemfile
gem 'rails', '~> 7.1.3'
```

```bash
bundle update rails
bin/rails app:update
```

### 2.2 Configuration Updates

**Update load_defaults:**
```ruby
# config/application.rb
config.load_defaults 7.1
```

**New Rails 7.1 features to configure:**
- Enhanced autoloading
- Improved Active Record features
- New security configurations

## Phase 3: Rails 7.2 Upgrade (Final)

### 3.1 Update to Rails 7.2.2.1

```ruby
# In Gemfile  
gem 'rails', '~> 7.2.2', '>= 7.2.2.1'
```

```bash
bundle update rails
bin/rails app:update
```

### 3.2 Final Configuration Updates

```ruby
# config/application.rb
config.load_defaults 7.2
```

### 3.3 New Rails 7.2 Features (Optional)

**Browser version guards:**
```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  # Optional: enforce modern browsers
  # allow_browser versions: :modern
end
```

**Progressive Web App setup:**
```bash
# PWA files are generated automatically in app/views/pwa/
# Review and customize:
# - app/views/pwa/manifest.json.erb  
# - app/views/pwa/service-worker.js
```

## Testing Strategy

### Test Each Phase

```bash
# After each Rails version upgrade:

# 1. Boot the application
bin/rails server

# 2. Run the full test suite
bundle exec rspec

# 3. Test critical functionality
bin/rails console
# Test models, queries, etc.

# 4. Test in browser
# - Login/logout
# - Admin interface
# - Form submissions
# - Any custom features
```

### Performance Testing

```bash
# Test application performance
bin/rails runner "puts Benchmark.measure { User.count }"

# Check YJIT is enabled (Ruby 3.3+)
bin/rails runner "puts RubyVM::YJIT.enabled?"
```

## Common Issues and Solutions

### Issue 1: Webpacker Compatibility
```bash
# If Webpacker fails to compile
yarn install
bin/rails webpacker:compile

# Consider upgrading or migrating to modern bundling
```

### Issue 2: Zeitwerk Autoloading Errors
```ruby
# Add to config/application.rb if needed
config.autoload_paths += %W(#{config.root}/lib)

# Or use the new Rails 7+ way:
config.autoload_lib(ignore: %w(tasks))
```

### Issue 3: ActiveAdmin Compatibility
```bash
# Update ActiveAdmin to latest version
bundle update activeadmin

# Check for Rails 7.2 compatibility issues in admin files
```

### Issue 4: Spring Issues
```bash
# Stop Spring and restart
bin/spring stop
bin/spring start

# Or remove Spring temporarily if causing issues
# Comment out in Gemfile and bundle install
```

## Post-Upgrade Checklist

### Immediate Verification
- [ ] Application boots without errors
- [ ] All tests pass
- [ ] Database migrations run successfully
- [ ] Assets compile correctly
- [ ] Authentication works (Devise)
- [ ] Admin interface works (ActiveAdmin)
- [ ] Forms submit correctly
- [ ] Background jobs process (if any)

### Performance Verification
- [ ] Page load times maintained
- [ ] Database query performance
- [ ] Memory usage reasonable
- [ ] YJIT enabled and working

### Security Verification  
- [ ] Authentication flows secure
- [ ] Authorization working correctly
- [ ] CSRF protection active
- [ ] New security headers configured

## Rollback Procedure

If issues arise:

```bash
# 1. Stop the application
# 2. Revert to backup branch
git checkout rails-upgrade-backup

# 3. Restore database if needed
# (Use your database backup strategy)

# 4. Deploy previous version
# (Use your deployment strategy)
```

## Final Deployment Commands

```bash
# When ready for production deployment:

# 1. Create release branch
git checkout -b release/rails-7-2-upgrade

# 2. Final testing
bundle exec rspec
bin/rails assets:precompile RAILS_ENV=production

# 3. Tag the release
git tag -a v1.0.0-rails7.2 -m "Rails 7.2.2.1 upgrade"

# 4. Deploy using your deployment strategy
# (Capistrano, Docker, etc.)
```

## Resources for Troubleshooting

### Log Files to Monitor
- `log/development.log` - Application logs
- `log/test.log` - Test logs  
- Browser developer console - JS errors

### Useful Commands
```bash
# Check Rails configuration
bin/rails runner "puts Rails.application.config.inspect"

# Check loaded gems
bin/rails runner "puts Gem.loaded_specs.keys.sort"

# Check autoload paths
bin/rails runner "puts Rails.autoloaders.main.dirs"

# Test specific functionality
bin/rails console
```

### Getting Help
- Rails Guides: https://guides.rubyonrails.org/
- Rails Issues: https://github.com/rails/rails/issues
- Stack Overflow: Rails 7.2 specific questions
- RailsBump: Gem compatibility checking

---

**Remember**: Take your time with each phase, test thoroughly, and maintain good backups throughout the process!